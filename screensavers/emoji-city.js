const EmojiCityScreensaver = {
  canvas: null,
  ctx: null,
  animationId: null,
  fixedWidth: null,
  fixedHeight: null,
  lastFrameTime: 0,

  // Scene management
  currentSceneIndex: 0,
  sceneTimer: 0,
  transitioning: false,
  transitionAlpha: 1,
  transitionPhase: 'none',

  // Cached background
  backgroundCanvas: null,
  backgroundCtx: null,

  // Sprite collections
  staticSprites: [],
  dynamicSprites: [],
  weatherEffects: [],

  // Configuration
  sceneDuration: 60000,
  speed: 2,
  emojiDensity: 'normal',
  weatherEnabled: true,
  sceneOrder: 'sequential',
  backgroundStyle: 'solid',
  targetFps: 60,
  maxFramerate: 0,

  // Reference resolution for scaling (1080p)
  REFERENCE_WIDTH: 1920,
  REFERENCE_HEIGHT: 1080,

  // Emoji size scale
  SIZES: {
    tiny: 16,
    small: 24,
    medium: 32,
    large: 48,
    xlarge: 64,
    huge: 80
  },

  // Movement patterns
  MOVEMENTS: {
    linear: {
      update(sprite, delta, screensaver) {
        sprite.x += sprite.vx * delta * screensaver.speed;
        sprite.y += sprite.vy * delta * screensaver.speed;
      }
    },
    walk: {
      update(sprite, delta, screensaver) {
        sprite.x += sprite.vx * delta * screensaver.speed;
        sprite.pathData.phase = (sprite.pathData.phase || 0) + 0.15 * delta;
        sprite.y = sprite.baseY + Math.sin(sprite.pathData.phase) * 3;

        // Frame animation
        sprite.pathData.frameTimer = (sprite.pathData.frameTimer || 0) + delta * 16.67;
        if (sprite.frames && sprite.pathData.frameTimer > 300) {
          sprite.pathData.frameTimer = 0;
          sprite.pathData.frameIndex = ((sprite.pathData.frameIndex || 0) + 1) % sprite.frames.length;
        }
      }
    },
    fly: {
      update(sprite, delta, screensaver) {
        sprite.x += sprite.vx * delta * screensaver.speed;
        sprite.y += sprite.vy * delta * screensaver.speed;
        sprite.pathData.phase = (sprite.pathData.phase || 0) + 0.05 * delta;
        sprite.y = sprite.baseY + Math.sin(sprite.pathData.phase) * 15 + sprite.vy * delta * screensaver.speed;
      }
    },
    boat: {
      update(sprite, delta, screensaver) {
        sprite.x += sprite.vx * delta * screensaver.speed;
        sprite.pathData.phase = (sprite.pathData.phase || 0) + 0.08 * delta;
        sprite.y = sprite.baseY + Math.sin(sprite.pathData.phase) * 5;
        sprite.rotation = Math.sin(sprite.pathData.phase) * 0.08;
      }
    },
    wander: {
      update(sprite, delta, screensaver) {
        sprite.pathData.timer = (sprite.pathData.timer || 0) + delta;
        if (sprite.pathData.timer > 60 + Math.random() * 60) {
          sprite.pathData.timer = 0;
          sprite.vx += (Math.random() - 0.5) * 0.8;
          sprite.vy += (Math.random() - 0.5) * 0.4;
          sprite.vx = Math.max(-1.5, Math.min(1.5, sprite.vx));
          sprite.vy = Math.max(-0.5, Math.min(0.5, sprite.vy));
        }
        sprite.x += sprite.vx * delta * screensaver.speed * 0.5;
        sprite.y += sprite.vy * delta * screensaver.speed * 0.5;

        // Bounce off bounds
        const bounds = sprite.pathData.bounds;
        if (bounds) {
          if (sprite.x < bounds.x) { sprite.x = bounds.x; sprite.vx = Math.abs(sprite.vx); }
          if (sprite.x > bounds.x + bounds.w) { sprite.x = bounds.x + bounds.w; sprite.vx = -Math.abs(sprite.vx); }
          if (sprite.y < bounds.y) { sprite.y = bounds.y; sprite.vy = Math.abs(sprite.vy); }
          if (sprite.y > bounds.y + bounds.h) { sprite.y = bounds.y + bounds.h; sprite.vy = -Math.abs(sprite.vy); }
        }
        // Flip based on velocity and default facing direction
        if (sprite.facesLeft) {
          sprite.flipH = sprite.vx > 0;  // Flip if moving right
        } else {
          sprite.flipH = sprite.vx < 0;  // Flip if moving left
        }
      }
    },
    flutter: {
      update(sprite, delta, screensaver) {
        sprite.pathData.phase = (sprite.pathData.phase || Math.random() * Math.PI * 2);
        sprite.pathData.phase += 0.2 * delta;
        sprite.x += sprite.vx * delta * screensaver.speed + Math.sin(sprite.pathData.phase * 2) * 0.8;
        sprite.y += sprite.vy * delta * screensaver.speed + Math.cos(sprite.pathData.phase) * 0.5;
      }
    }
  },

  // Scene definitions
  SCENES: [
    // Scene 1: Downtown Traffic (Night)
    {
      name: 'Downtown Traffic',
      backgroundColor: '#0a0a1a',
      charColors: {
        'â–ˆ': '#1a1a2e',
        'â–“': '#ffd700',
        'â–’': '#2d3436',
        'â–‘': '#444',
        'â•': '#333',
        'â”€': '#555',
        'â”‚': '#2a2a2a',
        ' ': 'transparent'
      },
      asciiArt: [
        '                                                                                ',
        '    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  ',
        '    â–ˆâ–ˆâ–“â–“â–ˆâ–ˆ    â–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–ˆâ–ˆâ–“â–“â–ˆâ–ˆ    â–ˆâ–ˆâ–“â–“â–ˆâ–ˆ    â–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–ˆâ–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–“â–“â–ˆâ–ˆ    â–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–ˆâ–ˆ  ',
        '    â–ˆâ–ˆâ–“â–“â–ˆâ–ˆ    â–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–ˆâ–ˆâ–“â–“â–ˆâ–ˆ    â–ˆâ–ˆâ–“â–“â–ˆâ–ˆ    â–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–ˆâ–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–“â–“â–ˆâ–ˆ    â–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–ˆâ–ˆ  ',
        '    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  ',
        '    â–ˆâ–ˆâ–“â–“â–ˆâ–ˆ    â–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–ˆâ–ˆâ–“â–“â–ˆâ–ˆ    â–ˆâ–ˆâ–“â–“â–ˆâ–ˆ    â–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–ˆâ–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–“â–“â–ˆâ–ˆ    â–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–ˆâ–ˆ  ',
        '    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  ',
        '    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  ',
        '    â”‚    â”‚    â”‚          â”‚    â”‚    â”‚    â”‚              â”‚    â”‚    â”‚    â”‚      â”‚  ',
        'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•',
        'â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘',
        'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€',
        'â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘',
        'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•',
        'â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’',
      ],
      staticEmojis: [
        { emoji: 'ðŸš¦', nx: 0.15, ny: 0.58, size: 'medium' },
        { emoji: 'ðŸš¦', nx: 0.5, ny: 0.58, size: 'medium' },
        { emoji: 'ðŸš¦', nx: 0.85, ny: 0.58, size: 'medium' },
        { emoji: 'ðŸ’¡', nx: 0.08, ny: 0.55, size: 'small' },
        { emoji: 'ðŸ’¡', nx: 0.35, ny: 0.55, size: 'small' },
        { emoji: 'ðŸ’¡', nx: 0.65, ny: 0.55, size: 'small' },
        { emoji: 'ðŸ’¡', nx: 0.92, ny: 0.55, size: 'small' },
        { emoji: 'ðŸ—‘ï¸', nx: 0.2, ny: 0.92, size: 'small' },
        { emoji: 'ðŸ—‘ï¸', nx: 0.7, ny: 0.92, size: 'small' },
        { emoji: 'ðŸŒ™', nx: 0.9, ny: 0.08, size: 'xlarge' },
      ],
      dynamicEmojis: [
        { emoji: 'ðŸš—', spawnX: -0.1, ny: 0.72, size: 'large', movement: 'linear', vx: 2.5, respawn: true, facesLeft: true, flipH: true },
        { emoji: 'ðŸš•', spawnX: 1.1, ny: 0.78, size: 'large', movement: 'linear', vx: -2, respawn: true, facesLeft: true },
        { emoji: 'ðŸš™', spawnX: -0.1, ny: 0.72, size: 'large', movement: 'linear', vx: 1.8, respawn: true, delay: 2000, facesLeft: true, flipH: true },
        { emoji: 'ðŸšŒ', spawnX: 1.1, ny: 0.78, size: 'xlarge', movement: 'linear', vx: -1.5, respawn: true, delay: 3000, facesLeft: true },
        { emoji: 'ðŸš', spawnX: -0.1, ny: 0.72, size: 'large', movement: 'linear', vx: 2.2, respawn: true, delay: 4000, facesLeft: true, flipH: true },
        { emoji: 'ðŸï¸', spawnX: -0.1, ny: 0.73, size: 'medium', movement: 'linear', vx: 3.5, respawn: true, delay: 1500, facesLeft: true, flipH: true },
        { emoji: 'ðŸ›µ', spawnX: 1.1, ny: 0.77, size: 'medium', movement: 'linear', vx: -3, respawn: true, delay: 2500, facesLeft: true },
        { emoji: 'ðŸš¶', spawnX: 0.1, ny: 0.92, size: 'medium', movement: 'walk', vx: 0.5, respawn: true },
        { emoji: 'ðŸš¶â€â™€ï¸', spawnX: 0.9, ny: 0.92, size: 'medium', movement: 'walk', vx: -0.4, respawn: true, flipH: true },
        { emoji: 'ðŸ•', spawnX: 0.15, ny: 0.93, size: 'small', movement: 'walk', vx: 0.6, respawn: true, delay: 5000 },
      ],
      weather: null
    },

    // Scene 2: Beach Day
    {
      name: 'Beach Day',
      backgroundColor: '#87CEEB',
      charColors: {
        'â–‘': '#87CEEB',
        'â–’': '#5fb4e8',
        'â–“': '#3498db',
        'â–ˆ': '#2980b9',
        '~': '#4aa3df',
        'â‰ˆ': '#3498db',
        '.': '#f4d03f',
        ':': '#f1c40f',
        ' ': 'transparent'
      },
      asciiArt: [
        'â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘',
        'â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘',
        'â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘',
        'â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’',
        '~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ',
        'â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~',
        'â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“',
        'â–ˆ~â–ˆ~â–ˆ~â–ˆ~â–ˆ~â–ˆ~â–ˆ~â–ˆ~â–ˆ~â–ˆ~â–ˆ~â–ˆ~â–ˆ~â–ˆ~â–ˆ~â–ˆ~â–ˆ~â–ˆ~â–ˆ~â–ˆ~â–ˆ~â–ˆ~â–ˆ~â–ˆ~â–ˆ~â–ˆ~â–ˆ~â–ˆ~â–ˆ~â–ˆ~â–ˆ~â–ˆ~â–ˆ~â–ˆ~â–ˆ~â–ˆ~â–ˆ~â–ˆ~â–ˆ~â–ˆ~',
        '::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::',
        '................................................................................',
        '.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.',
        '................................................................................',
        '.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.',
        '................................................................................',
        '................................................................................',
      ],
      staticEmojis: [
        { emoji: 'â˜€ï¸', nx: 0.1, ny: 0.08, size: 'huge' },
        { emoji: 'ðŸŒ´', nx: 0.05, ny: 0.7, size: 'xlarge' },
        { emoji: 'ðŸŒ´', nx: 0.95, ny: 0.65, size: 'xlarge' },
        { emoji: 'â›±ï¸', nx: 0.3, ny: 0.75, size: 'large' },
        { emoji: 'â›±ï¸', nx: 0.7, ny: 0.78, size: 'large' },
        { emoji: 'ðŸ¦€', nx: 0.4, ny: 0.88, size: 'small' },
        { emoji: 'ðŸš', nx: 0.55, ny: 0.92, size: 'small' },
        { emoji: 'ðŸš', nx: 0.25, ny: 0.95, size: 'tiny' },
        { emoji: 'ðŸ–ï¸', nx: 0.5, ny: 0.8, size: 'medium' },
        { emoji: 'ðŸª£', nx: 0.6, ny: 0.85, size: 'small' },
      ],
      dynamicEmojis: [
        { emoji: 'â›µ', spawnX: -0.1, ny: 0.38, size: 'xlarge', movement: 'boat', vx: 0.8, respawn: true, facesLeft: true, flipH: true },
        { emoji: 'ðŸš¤', spawnX: 1.1, ny: 0.42, size: 'large', movement: 'boat', vx: -1.5, respawn: true, facesLeft: true, delay: 3000 },
        { emoji: 'ðŸ›¥ï¸', spawnX: -0.1, ny: 0.35, size: 'large', movement: 'boat', vx: 1.2, respawn: true, delay: 5000, facesLeft: true, flipH: true },
        { emoji: 'ðŸ„', spawnX: 0.6, ny: 0.48, size: 'medium', movement: 'boat', vx: 1.5, respawn: true, facesLeft: true, flipH: true },
        { emoji: 'ðŸ¦…', spawnX: -0.1, ny: 0.15, size: 'medium', movement: 'fly', vx: 1.5, vy: 0, respawn: true, facesLeft: true, flipH: true },
        { emoji: 'ðŸ¦', spawnX: 1.1, ny: 0.12, size: 'small', movement: 'fly', vx: -1.2, vy: 0, respawn: true, delay: 2000, facesLeft: true },
        { emoji: 'âœˆï¸', spawnX: -0.15, ny: 0.06, size: 'medium', movement: 'linear', vx: 2, vy: 0.1, respawn: true, delay: 10000, facesLeft: true, flipH: true },
        { emoji: 'ðŸš¶', spawnX: 0.1, ny: 0.9, size: 'medium', movement: 'walk', vx: 0.4, respawn: true },
        { emoji: 'ðŸƒ', spawnX: 0.8, ny: 0.88, size: 'medium', movement: 'walk', vx: -0.8, respawn: true, flipH: true, delay: 4000, facesLeft: true },
        { emoji: 'ðŸ•', spawnX: 0.85, ny: 0.89, size: 'small', movement: 'walk', vx: -0.9, respawn: true, delay: 4200 },
      ],
      weather: null
    },

    // Scene 3: Farm/Countryside
    {
      name: 'Farm',
      backgroundColor: '#87CEEB',
      charColors: {
        'â–‘': '#87CEEB',
        'â–’': '#90EE90',
        'â–“': '#228B22',
        'â–ˆ': '#8B4513',
        'â”‚': '#8B4513',
        'â”€': '#8B4513',
        '.': '#90EE90',
        ',': '#7CFC00',
        ' ': 'transparent'
      },
      asciiArt: [
        'â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘',
        'â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘',
        'â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘',
        'â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’',
        '.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.',
        ',.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.â”‚',
        '.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,â”‚.,â”‚',
        ',.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.â”‚.,.,â”‚.â”‚',
        'â”‚â”€â”€â”€â”€â”€â”‚.,.,.,.,.,.,.,.,.,â”‚â”€â”€â”€â”€â”€â”‚.,.,.,.,.,.,.,â”‚â”€â”€â”€â”€â”€â”‚.,.,.,.,.,.,â”‚.,.,.,â”‚â”€â”€â”€â”€â”€â”‚.â”‚',
        'â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“',
        'â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“',
        'â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“',
        'â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“',
        'â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“',
        'â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“',
      ],
      staticEmojis: [
        { emoji: 'â˜€ï¸', nx: 0.85, ny: 0.08, size: 'huge' },
        { emoji: 'â˜ï¸', nx: 0.2, ny: 0.1, size: 'large' },
        { emoji: 'â˜ï¸', nx: 0.5, ny: 0.05, size: 'xlarge' },
        { emoji: 'ðŸ ', nx: 0.08, ny: 0.45, size: 'xlarge' },
        { emoji: 'ðŸŒ³', nx: 0.02, ny: 0.55, size: 'large' },
        { emoji: 'ðŸŒ²', nx: 0.18, ny: 0.5, size: 'large' },
        { emoji: 'ðŸŒ¾', nx: 0.35, ny: 0.38, size: 'medium' },
        { emoji: 'ðŸŒ¾', nx: 0.4, ny: 0.4, size: 'medium' },
        { emoji: 'ðŸŒ¾', nx: 0.45, ny: 0.38, size: 'medium' },
        { emoji: 'ðŸŒ»', nx: 0.6, ny: 0.42, size: 'medium' },
        { emoji: 'ðŸŒ·', nx: 0.65, ny: 0.4, size: 'small' },
        { emoji: 'ðŸŒ¼', nx: 0.7, ny: 0.43, size: 'small' },
      ],
      dynamicEmojis: [
        { emoji: 'ðŸ„', nx: 0.3, ny: 0.75, size: 'large', movement: 'wander', vx: 0.3, vy: 0.1, bounds: { nx: 0.2, ny: 0.65, nw: 0.3, nh: 0.2 }, facesLeft: true },
        { emoji: 'ðŸ®', nx: 0.4, ny: 0.8, size: 'large', movement: 'wander', vx: -0.2, vy: 0.05, bounds: { nx: 0.2, ny: 0.65, nw: 0.3, nh: 0.2 }, facesLeft: true },
        { emoji: 'ðŸ‘', nx: 0.6, ny: 0.7, size: 'medium', movement: 'wander', vx: 0.2, vy: 0.1, bounds: { nx: 0.55, ny: 0.65, nw: 0.25, nh: 0.2 }, facesLeft: true },
        { emoji: 'ðŸ', nx: 0.7, ny: 0.75, size: 'medium', movement: 'wander', vx: -0.3, vy: 0, bounds: { nx: 0.55, ny: 0.65, nw: 0.25, nh: 0.2 }, facesLeft: true },
        { emoji: 'ðŸ”', nx: 0.15, ny: 0.7, size: 'small', movement: 'wander', vx: 0.4, vy: 0.2, bounds: { nx: 0.1, ny: 0.6, nw: 0.15, nh: 0.25 }, facesLeft: true },
        { emoji: 'ðŸ“', nx: 0.2, ny: 0.68, size: 'small', movement: 'wander', vx: -0.3, vy: 0.1, bounds: { nx: 0.1, ny: 0.6, nw: 0.15, nh: 0.25 }, facesLeft: true },
        { emoji: 'ðŸ´', nx: 0.85, ny: 0.72, size: 'large', movement: 'wander', vx: 0.2, vy: 0, bounds: { nx: 0.8, ny: 0.65, nw: 0.15, nh: 0.2 }, facesLeft: true },
        { emoji: 'ðŸ¦†', nx: 0.5, ny: 0.85, size: 'small', movement: 'wander', vx: 0.3, vy: 0.1, bounds: { nx: 0.45, ny: 0.8, nw: 0.15, nh: 0.12 }, facesLeft: true },
        { emoji: 'ðŸšœ', spawnX: -0.1, ny: 0.55, size: 'xlarge', movement: 'linear', vx: 0.8, respawn: true, delay: 8000, facesLeft: true, flipH: true },
        { emoji: 'ðŸ¦‹', spawnX: 0.3, ny: 0.35, size: 'small', movement: 'flutter', vx: 0.3, vy: -0.1, respawn: true },
        { emoji: 'ðŸ', spawnX: 0.6, ny: 0.38, size: 'tiny', movement: 'flutter', vx: 0.4, vy: 0.05, respawn: true, delay: 2000 },
      ],
      weather: null
    },

    // Scene 4: Airport
    {
      name: 'Airport',
      backgroundColor: '#c9d6df',
      charColors: {
        'â–‘': '#c9d6df',
        'â–’': '#a4b0be',
        'â–“': '#636e72',
        'â–ˆ': '#2d3436',
        'â•': '#555',
        'â”€': '#666',
        'â”‚': '#777',
        '.': '#888',
        ' ': 'transparent'
      },
      asciiArt: [
        'â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘',
        'â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘',
        'â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘',
        'â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’',
        'â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ',
        'â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“',
        'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•',
        '........â”€.â”€.â”€.â”€.â”€.â”€.â”€.â”€.â”€.â”€.â”€.â”€.â”€.â”€.â”€.â”€.â”€.â”€.â”€.â”€.â”€.â”€.â”€.â”€.â”€.â”€.â”€.â”€.â”€.â”€.â”€.â”€........',
        'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•',
        'â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“',
        'â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“',
        'â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“',
        'â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“',
        'â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“',
        'â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“',
      ],
      staticEmojis: [
        { emoji: 'ðŸ¢', nx: 0.1, ny: 0.32, size: 'xlarge' },
        { emoji: 'ðŸ—¼', nx: 0.92, ny: 0.28, size: 'xlarge' },
        { emoji: 'ðŸ§³', nx: 0.2, ny: 0.65, size: 'medium' },
        { emoji: 'ðŸ§³', nx: 0.25, ny: 0.68, size: 'small' },
        { emoji: 'ðŸ›„', nx: 0.3, ny: 0.66, size: 'medium' },
        { emoji: 'ðŸš§', nx: 0.7, ny: 0.6, size: 'small' },
        { emoji: 'ðŸš§', nx: 0.75, ny: 0.6, size: 'small' },
        { emoji: 'ðŸ›¬', nx: 0.5, ny: 0.35, size: 'huge' },
      ],
      dynamicEmojis: [
        { emoji: 'âœˆï¸', spawnX: -0.2, spawnY: 0.3, size: 'xlarge', movement: 'linear', vx: 1.5, vy: -0.3, respawn: true, delay: 0, facesLeft: true, flipH: true },
        { emoji: 'ðŸ›«', spawnX: 0.2, spawnY: 0.5, size: 'xlarge', movement: 'linear', vx: 1.2, vy: -0.5, respawn: true, delay: 8000, facesLeft: true, flipH: true },
        { emoji: 'âœˆï¸', spawnX: 1.2, spawnY: 0.05, size: 'large', movement: 'linear', vx: -1.8, vy: 0.2, respawn: true, delay: 4000, facesLeft: true },
        { emoji: 'ðŸš', spawnX: 1.1, ny: 0.15, size: 'large', movement: 'fly', vx: -1, vy: 0, respawn: true, delay: 12000, facesLeft: true },
        { emoji: 'ðŸš', spawnX: -0.1, ny: 0.52, size: 'large', movement: 'linear', vx: 1.5, respawn: true, facesLeft: true, flipH: true },
        { emoji: 'ðŸš›', spawnX: 1.1, ny: 0.52, size: 'large', movement: 'linear', vx: -1.2, respawn: true, delay: 3000, facesLeft: true },
        { emoji: 'ðŸ›»', spawnX: -0.1, ny: 0.52, size: 'medium', movement: 'linear', vx: 1.8, respawn: true, delay: 6000, facesLeft: true, flipH: true },
        { emoji: 'ðŸ‘·', spawnX: 0.4, ny: 0.65, size: 'medium', movement: 'walk', vx: 0.3, respawn: true },
        { emoji: 'ðŸ§‘â€âœˆï¸', spawnX: 0.6, ny: 0.67, size: 'medium', movement: 'walk', vx: -0.25, respawn: true, flipH: true, delay: 2000 },
      ],
      weather: { type: 'cloudy' }
    },

    // Scene 5: Harbor/Marina
    {
      name: 'Harbor',
      backgroundColor: '#5dade2',
      charColors: {
        'â–‘': '#85c1e9',
        'â–’': '#5dade2',
        'â–“': '#3498db',
        'â–ˆ': '#2c3e50',
        '~': '#5499c7',
        'â‰ˆ': '#3498db',
        'â•': '#8B4513',
        'â”€': '#a67c52',
        'â”‚': '#8B4513',
        ' ': 'transparent'
      },
      asciiArt: [
        'â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘',
        'â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘',
        'â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘',
        'â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘',
        'â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’',
        '~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ',
        'â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~â‰ˆ~',
        'â–“~â–“~â–“~â–“~â–“~â–“~â–“~â–“~â–“~â–“~â–“~â–“~â–“~â–“~â–“~â–“~â–“~â–“~â–“~â–“~â–“~â–“~â–“~â–“~â–“~â–“~â–“~â–“~â–“~â–“~â–“~â–“~â–“~â–“~â–“~â–“~â–“~â–“~â–“~â–“~',
        'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”‚â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•',
        'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”‚â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•',
        '                                         â”‚                                     ',
        '                                         â”‚                                     ',
        'â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â”‚â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“',
        'â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“',
        'â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“',
      ],
      staticEmojis: [
        { emoji: 'ðŸ—ï¸', nx: 0.08, ny: 0.5, size: 'xlarge' },
        { emoji: 'âš“', nx: 0.55, ny: 0.62, size: 'large' },
        { emoji: 'ðŸ§­', nx: 0.35, ny: 0.65, size: 'medium' },
        { emoji: 'â˜ï¸', nx: 0.7, ny: 0.08, size: 'large' },
        { emoji: 'â˜ï¸', nx: 0.4, ny: 0.05, size: 'xlarge' },
      ],
      dynamicEmojis: [
        { emoji: 'ðŸš¢', spawnX: -0.15, ny: 0.38, size: 'xlarge', movement: 'boat', vx: 0.5, respawn: true, facesLeft: true, flipH: true },
        { emoji: 'â›´ï¸', spawnX: 1.15, ny: 0.42, size: 'xlarge', movement: 'boat', vx: -0.6, respawn: true, delay: 5000, facesLeft: true },
        { emoji: 'â›µ', spawnX: -0.1, ny: 0.35, size: 'large', movement: 'boat', vx: 0.9, respawn: true, delay: 3000, facesLeft: true, flipH: true },
        { emoji: 'ðŸ›¶', spawnX: 1.1, ny: 0.48, size: 'medium', movement: 'boat', vx: -0.7, respawn: true, delay: 7000, facesLeft: true },
        { emoji: 'ðŸš¤', spawnX: -0.1, ny: 0.45, size: 'large', movement: 'boat', vx: 1.8, respawn: true, delay: 10000, facesLeft: true, flipH: true },
        { emoji: 'ðŸ¦†', nx: 0.6, ny: 0.5, size: 'small', movement: 'boat', vx: 0.2, bounds: { nx: 0.5, ny: 0.45, nw: 0.3, nh: 0.1 }, facesLeft: true },
        { emoji: 'ðŸ¦†', nx: 0.65, ny: 0.52, size: 'small', movement: 'boat', vx: -0.15, bounds: { nx: 0.5, ny: 0.45, nw: 0.3, nh: 0.1 }, facesLeft: true },
        { emoji: 'ðŸ¦…', spawnX: -0.1, ny: 0.12, size: 'medium', movement: 'fly', vx: 1.2, vy: 0, respawn: true, facesLeft: true, flipH: true },
        { emoji: 'ðŸ¦', spawnX: 1.1, ny: 0.18, size: 'small', movement: 'fly', vx: -1.5, vy: 0, respawn: true, delay: 4000, facesLeft: true },
        { emoji: 'ðŸš¶', spawnX: 0.1, ny: 0.62, size: 'medium', movement: 'walk', vx: 0.4, respawn: true },
        { emoji: 'ðŸš¶â€â™€ï¸', spawnX: 0.7, ny: 0.63, size: 'medium', movement: 'walk', vx: -0.35, respawn: true, flipH: true, delay: 3000 },
      ],
      weather: null
    },

    // Scene 6: Park/Zoo
    {
      name: 'Park & Zoo',
      backgroundColor: '#87CEEB',
      charColors: {
        'â–‘': '#87CEEB',
        'â–’': '#98D8AA',
        'â–“': '#57A773',
        'â–ˆ': '#2E7D32',
        '~': '#5dade2',
        '.': '#c8e6c9',
        ',': '#a5d6a7',
        'â”€': '#bcaaa4',
        ' ': 'transparent'
      },
      asciiArt: [
        'â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘',
        'â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘',
        'â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’',
        '.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.',
        ',.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.â”‚',
        'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€.,.,.,.,.,.,.,.,.,â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€',
        'â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“.,.,.,.,.,.,.,.,.,â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“',
        'â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“.,.,~~~~~~~~~~~.,.,â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“',
        'â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“.,~~~~~~~~~~~~~.,.,â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“',
        'â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“.,.,~~~~~~~~~~~.,.,â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“',
        'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€.,.,.,.,.,.,.,.,.,â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€',
        '.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.',
        ',.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.â”‚',
        '.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.,.',
        'â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“',
      ],
      staticEmojis: [
        { emoji: 'â˜€ï¸', nx: 0.9, ny: 0.05, size: 'huge' },
        { emoji: 'â˜ï¸', nx: 0.3, ny: 0.08, size: 'large' },
        { emoji: 'ðŸŒ³', nx: 0.05, ny: 0.35, size: 'xlarge' },
        { emoji: 'ðŸŒ²', nx: 0.12, ny: 0.4, size: 'large' },
        { emoji: 'ðŸŒ´', nx: 0.95, ny: 0.38, size: 'xlarge' },
        { emoji: 'ðŸŒ³', nx: 0.88, ny: 0.42, size: 'large' },
        { emoji: 'ðŸª‘', nx: 0.3, ny: 0.35, size: 'medium' },
        { emoji: 'ðŸª‘', nx: 0.7, ny: 0.35, size: 'medium' },
        { emoji: 'â›²', nx: 0.5, ny: 0.52, size: 'xlarge' },
        { emoji: 'ðŸ—‘ï¸', nx: 0.25, ny: 0.38, size: 'small' },
        { emoji: 'ðŸ—‘ï¸', nx: 0.75, ny: 0.38, size: 'small' },
        { emoji: 'ðŸŽª', nx: 0.15, ny: 0.8, size: 'xlarge' },
      ],
      dynamicEmojis: [
        // Zoo animals in enclosures (left side)
        { emoji: 'ðŸ¦', nx: 0.08, ny: 0.5, size: 'large', movement: 'wander', vx: 0.2, vy: 0.1, bounds: { nx: 0.02, ny: 0.42, nw: 0.2, nh: 0.2 }, facesLeft: true },
        { emoji: 'ðŸ¯', nx: 0.15, ny: 0.55, size: 'large', movement: 'wander', vx: -0.15, vy: 0, bounds: { nx: 0.02, ny: 0.42, nw: 0.2, nh: 0.2 }, facesLeft: true },
        // Zoo animals (right side)
        { emoji: 'ðŸ˜', nx: 0.85, ny: 0.5, size: 'xlarge', movement: 'wander', vx: -0.1, vy: 0.05, bounds: { nx: 0.78, ny: 0.42, nw: 0.2, nh: 0.2 }, facesLeft: true },
        { emoji: 'ðŸ¦’', nx: 0.92, ny: 0.48, size: 'xlarge', movement: 'wander', vx: 0.1, vy: -0.05, bounds: { nx: 0.78, ny: 0.42, nw: 0.2, nh: 0.2 }, facesLeft: true },
        // Birds near pond
        { emoji: 'ðŸ¦¢', nx: 0.48, ny: 0.55, size: 'medium', movement: 'boat', vx: 0.1, facesLeft: true },
        { emoji: 'ðŸ¦†', nx: 0.52, ny: 0.57, size: 'small', movement: 'boat', vx: -0.15, facesLeft: true },
        // Walking visitors
        { emoji: 'ðŸš¶', spawnX: 0.1, ny: 0.73, size: 'medium', movement: 'walk', vx: 0.4, respawn: true },
        { emoji: 'ðŸ‘¨â€ðŸ‘©â€ðŸ‘§', spawnX: 0.9, ny: 0.72, size: 'medium', movement: 'walk', vx: -0.3, respawn: true, flipH: true, delay: 3000 },
        { emoji: 'ðŸš¶â€â™€ï¸', spawnX: 0.2, ny: 0.35, size: 'medium', movement: 'walk', vx: 0.35, respawn: true, delay: 5000 },
        // Bikes and scooters
        { emoji: 'ðŸš²', spawnX: -0.1, ny: 0.36, size: 'medium', movement: 'linear', vx: 1.5, respawn: true, delay: 7000, facesLeft: true, flipH: true },
        { emoji: 'ðŸ›´', spawnX: 1.1, ny: 0.72, size: 'medium', movement: 'linear', vx: -1.8, respawn: true, delay: 4000, facesLeft: true },
        // Pets
        { emoji: 'ðŸ•', nx: 0.4, ny: 0.75, size: 'small', movement: 'wander', vx: 0.4, vy: 0.1, bounds: { nx: 0.3, ny: 0.68, nw: 0.4, nh: 0.15 }, facesLeft: true },
        { emoji: 'ðŸˆ', nx: 0.6, ny: 0.78, size: 'small', movement: 'wander', vx: -0.3, vy: 0.05, bounds: { nx: 0.3, ny: 0.68, nw: 0.4, nh: 0.15 }, facesLeft: true },
        // Butterflies and birds
        { emoji: 'ðŸ¦‹', spawnX: 0.3, ny: 0.25, size: 'small', movement: 'flutter', vx: 0.3, vy: 0.1, respawn: true },
        { emoji: 'ðŸ¦‹', spawnX: 0.7, ny: 0.28, size: 'small', movement: 'flutter', vx: -0.25, vy: -0.05, respawn: true, delay: 2000 },
        { emoji: 'ðŸ¦œ', spawnX: -0.1, ny: 0.15, size: 'medium', movement: 'fly', vx: 1.3, vy: 0, respawn: true, delay: 6000, facesLeft: true, flipH: true },
        { emoji: 'ðŸ¦©', nx: 0.45, ny: 0.58, size: 'medium', movement: 'wander', vx: 0.1, vy: 0, bounds: { nx: 0.4, ny: 0.52, nw: 0.2, nh: 0.1 }, facesLeft: true },
      ],
      weather: null
    }
  ],

  init(options = {}) {
    this.canvas = options.canvas || document.getElementById('screensaver-canvas');
    this.ctx = this.canvas.getContext('2d');

    // Reset state
    this.staticSprites = [];
    this.dynamicSprites = [];
    this.weatherEffects = [];
    this.lastFrameTime = 0;
    this.sceneTimer = 0;
    this.currentSceneIndex = 0;
    this.transitioning = false;
    this.transitionAlpha = 1;

    // Apply settings
    this.sceneDuration = (options.sceneDuration || 60) * 1000;
    this.speed = options.speed || 2;
    this.emojiDensity = options.emojiDensity || 'normal';
    this.weatherEnabled = options.weatherEnabled !== false;
    this.sceneOrder = options.sceneOrder || 'sequential';
    this.backgroundStyle = options.backgroundStyle || 'solid';
    this.maxFramerate = options.maxFramerate || 0;

    // Preview mode support
    this.fixedWidth = options.width || null;
    this.fixedHeight = options.height || null;

    // Create background canvas for caching (must be before resize())
    this.backgroundCanvas = document.createElement('canvas');
    this.backgroundCtx = this.backgroundCanvas.getContext('2d');

    this.resize();

    if (!this.fixedWidth) {
      window.addEventListener('resize', this.handleResize);
    }

    // Initialize first scene
    this.initScene(this.currentSceneIndex);
    this.animate();
  },

  handleResize: function() {
    if (window.EmojiCityScreensaver.canvas && !window.EmojiCityScreensaver.fixedWidth) {
      window.EmojiCityScreensaver.resize();
      window.EmojiCityScreensaver.renderBackground();
    }
  },

  resize() {
    if (this.fixedWidth) {
      this.canvas.width = this.fixedWidth;
      this.canvas.height = this.fixedHeight;
    } else {
      this.canvas.width = window.innerWidth;
      this.canvas.height = window.innerHeight;
    }

    if (this.backgroundCanvas) {
      this.backgroundCanvas.width = this.canvas.width;
      this.backgroundCanvas.height = this.canvas.height;
    }
  },

  initScene(sceneIndex) {
    const scene = this.SCENES[sceneIndex];
    this.staticSprites = [];
    this.dynamicSprites = [];
    this.weatherEffects = [];

    // Density multiplier
    const densityMult = this.emojiDensity === 'sparse' ? 0.5 : this.emojiDensity === 'busy' ? 1.5 : 1;

    // Create static sprites
    for (const cfg of scene.staticEmojis) {
      this.staticSprites.push(this.createSprite(cfg, false));
    }

    // Create dynamic sprites
    for (const cfg of scene.dynamicEmojis) {
      // Skip some based on density
      if (densityMult < 1 && Math.random() > densityMult) continue;

      const sprite = this.createSprite(cfg, true);
      this.dynamicSprites.push(sprite);

      // Add extra sprites for busy mode
      if (densityMult > 1 && Math.random() < densityMult - 1) {
        const extraSprite = this.createSprite(cfg, true);
        extraSprite.x += (Math.random() - 0.5) * 100;
        extraSprite.pathData.delay = (cfg.delay || 0) + Math.random() * 3000;
        this.dynamicSprites.push(extraSprite);
      }
    }

    this.renderBackground();
  },

  createSprite(cfg, isDynamic) {
    const baseSize = this.SIZES[cfg.size] || this.SIZES.medium;

    // Scale size based on screen resolution relative to reference (1080p)
    // Use the smaller dimension ratio to ensure emojis scale proportionally
    const scaleX = this.canvas.width / this.REFERENCE_WIDTH;
    const scaleY = this.canvas.height / this.REFERENCE_HEIGHT;
    const resolutionScale = Math.min(scaleX, scaleY);

    // For small preview windows, scale down; for larger screens, scale up
    const scaledSize = baseSize * Math.max(0.5, resolutionScale);

    let x, y;
    if (cfg.spawnX !== undefined) {
      x = cfg.spawnX * this.canvas.width;
    } else if (cfg.nx !== undefined) {
      x = cfg.nx * this.canvas.width;
    } else {
      x = Math.random() * this.canvas.width;
    }

    if (cfg.spawnY !== undefined) {
      y = cfg.spawnY * this.canvas.height;
    } else if (cfg.ny !== undefined) {
      y = cfg.ny * this.canvas.height;
    } else {
      y = Math.random() * this.canvas.height;
    }

    const sprite = {
      emoji: cfg.emoji,
      x: x,
      y: y,
      baseY: y,
      size: scaledSize,
      vx: cfg.vx || 0,
      vy: cfg.vy || 0,
      zIndex: cfg.zIndex || (isDynamic ? 5 : 1),
      movement: cfg.movement || null,
      flipH: cfg.flipH || false,
      facesLeft: cfg.facesLeft || false,
      rotation: 0,
      frames: cfg.frames || null,
      respawn: cfg.respawn || false,
      pathData: {
        phase: Math.random() * Math.PI * 2,
        timer: 0,
        frameIndex: 0,
        frameTimer: 0,
        delay: cfg.delay || 0,
        bounds: cfg.bounds ? {
          x: cfg.bounds.nx * this.canvas.width,
          y: cfg.bounds.ny * this.canvas.height,
          w: cfg.bounds.nw * this.canvas.width,
          h: cfg.bounds.nh * this.canvas.height
        } : null
      }
    };

    // If has spawn delay, start off-screen
    if (isDynamic && cfg.delay) {
      sprite.pathData.waitingToSpawn = true;
      sprite.pathData.spawnTimer = 0;
    }

    return sprite;
  },

  renderBackground() {
    const scene = this.SCENES[this.currentSceneIndex];
    const ctx = this.backgroundCtx;
    const lines = scene.asciiArt;

    // Clear to background color
    ctx.fillStyle = scene.backgroundColor || '#000';
    ctx.fillRect(0, 0, this.backgroundCanvas.width, this.backgroundCanvas.height);

    if (!lines || lines.length === 0) return;

    // Calculate cell size to exactly fill the screen
    const maxLineLength = Math.max(...lines.map(l => l.length));
    const cellWidth = this.backgroundCanvas.width / maxLineLength;
    const cellHeight = this.backgroundCanvas.height / lines.length;

    if (this.backgroundStyle === 'ascii') {
      // ASCII text rendering - draws actual characters
      const fontSize = Math.max(cellHeight * 1.2, cellWidth * 1.5);
      ctx.font = `${fontSize}px monospace`;
      ctx.textBaseline = 'top';

      for (let row = 0; row < lines.length; row++) {
        const line = lines[row];
        for (let col = 0; col < line.length; col++) {
          const char = line[col];
          if (char === ' ') continue;

          const color = scene.charColors[char] || '#333';
          if (color === 'transparent') continue;

          ctx.fillStyle = color;
          ctx.fillText(char, col * cellWidth, row * cellHeight);
        }
      }
    } else {
      // Solid color rendering - draws filled rectangles (better scaling)
      for (let row = 0; row < lines.length; row++) {
        const line = lines[row];
        for (let col = 0; col < line.length; col++) {
          const char = line[col];
          if (char === ' ') continue;

          const color = scene.charColors[char] || '#333';
          if (color === 'transparent') continue;

          ctx.fillStyle = color;
          // Use fillRect for precise pixel-perfect coverage
          // Add 1px overlap to prevent gaps from rounding errors
          ctx.fillRect(
            Math.floor(col * cellWidth),
            Math.floor(row * cellHeight),
            Math.ceil(cellWidth) + 1,
            Math.ceil(cellHeight) + 1
          );
        }
      }
    }
  },

  updateSprite(sprite, delta) {
    // Handle spawn delay
    if (sprite.pathData.waitingToSpawn) {
      sprite.pathData.spawnTimer += delta * 16.67;
      if (sprite.pathData.spawnTimer < sprite.pathData.delay) {
        return;
      }
      sprite.pathData.waitingToSpawn = false;
    }

    // Apply movement pattern
    const pattern = this.MOVEMENTS[sprite.movement];
    if (pattern) {
      pattern.update(sprite, delta, this);
    }

    // Check for respawn
    if (sprite.respawn) {
      const margin = sprite.size * 2;
      const offScreen =
        sprite.x < -margin ||
        sprite.x > this.canvas.width + margin ||
        sprite.y < -margin ||
        sprite.y > this.canvas.height + margin;

      if (offScreen) {
        this.respawnSprite(sprite);
      }
    }
  },

  respawnSprite(sprite) {
    // Respawn at opposite edge based on velocity
    if (sprite.vx > 0) {
      sprite.x = -sprite.size;
    } else if (sprite.vx < 0) {
      sprite.x = this.canvas.width + sprite.size;
    }

    if (sprite.vy > 0) {
      sprite.y = -sprite.size;
    } else if (sprite.vy < 0) {
      sprite.y = this.canvas.height + sprite.size;
    }

    sprite.baseY = sprite.y;
    sprite.pathData.phase = Math.random() * Math.PI * 2;
  },

  drawSprite(sprite) {
    // Skip if waiting to spawn
    if (sprite.pathData.waitingToSpawn) return;

    const ctx = this.ctx;
    ctx.save();
    ctx.translate(sprite.x, sprite.y);

    if (sprite.rotation) {
      ctx.rotate(sprite.rotation);
    }

    if (sprite.flipH) {
      ctx.scale(-1, 1);
    }

    ctx.font = `${sprite.size}px "Segoe UI Emoji", "Apple Color Emoji", "Noto Color Emoji", sans-serif`;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';

    const emoji = sprite.frames
      ? sprite.frames[sprite.pathData.frameIndex || 0]
      : sprite.emoji;

    ctx.fillText(emoji, 0, 0);
    ctx.restore();
  },

  updateWeather(delta) {
    const scene = this.SCENES[this.currentSceneIndex];
    if (!this.weatherEnabled || !scene.weather) return;

    // Spawn weather particles
    if (scene.weather.type === 'rain' && Math.random() < 0.3 * delta) {
      this.weatherEffects.push({
        emoji: 'ðŸ’§',
        x: Math.random() * this.canvas.width,
        y: -20,
        size: this.SIZES.tiny,
        vx: -0.5,
        vy: 8,
        zIndex: 10
      });
    }

    if (scene.weather.type === 'snow' && Math.random() < 0.15 * delta) {
      this.weatherEffects.push({
        emoji: 'â„ï¸',
        x: Math.random() * this.canvas.width,
        y: -20,
        size: this.SIZES.tiny,
        vx: Math.sin(Math.random() * Math.PI * 2) * 0.3,
        vy: 1 + Math.random(),
        movement: 'flutter',
        pathData: { phase: Math.random() * Math.PI * 2 },
        zIndex: 10
      });
    }

    // Update and cull weather particles
    this.weatherEffects = this.weatherEffects.filter(p => {
      p.x += p.vx * delta * this.speed;
      p.y += p.vy * delta * this.speed;
      if (p.movement === 'flutter') {
        p.pathData.phase += 0.2 * delta;
        p.x += Math.sin(p.pathData.phase * 2) * 0.5;
      }
      return p.y < this.canvas.height + 50;
    });

    // Limit particle count
    const maxParticles = this.fixedWidth && this.fixedWidth < 600 ? 30 : 150;
    if (this.weatherEffects.length > maxParticles) {
      this.weatherEffects = this.weatherEffects.slice(-maxParticles);
    }
  },

  updateSceneTimer(delta) {
    this.sceneTimer += delta * 16.67;

    if (this.sceneTimer >= this.sceneDuration && !this.transitioning) {
      this.startTransition();
    }

    if (this.transitioning) {
      this.updateTransition(delta);
    }
  },

  startTransition() {
    this.transitioning = true;
    this.transitionPhase = 'fadeOut';
  },

  updateTransition(delta) {
    const fadeSpeed = 0.03 * delta;

    if (this.transitionPhase === 'fadeOut') {
      this.transitionAlpha -= fadeSpeed;
      if (this.transitionAlpha <= 0) {
        this.transitionAlpha = 0;

        // Switch scene
        if (this.sceneOrder === 'random') {
          let newIndex;
          do {
            newIndex = Math.floor(Math.random() * this.SCENES.length);
          } while (newIndex === this.currentSceneIndex && this.SCENES.length > 1);
          this.currentSceneIndex = newIndex;
        } else {
          this.currentSceneIndex = (this.currentSceneIndex + 1) % this.SCENES.length;
        }

        this.initScene(this.currentSceneIndex);
        this.sceneTimer = 0;
        this.transitionPhase = 'fadeIn';
      }
    } else if (this.transitionPhase === 'fadeIn') {
      this.transitionAlpha += fadeSpeed;
      if (this.transitionAlpha >= 1) {
        this.transitionAlpha = 1;
        this.transitioning = false;
        this.transitionPhase = 'none';
      }
    }
  },

  animate(timestamp = 0) {
    // Framerate limiting
    if (this.maxFramerate > 0 && this.lastFrameTime) {
      const minFrameTime = 1000 / this.maxFramerate;
      if (timestamp - this.lastFrameTime < minFrameTime) {
        this.animationId = requestAnimationFrame((t) => this.animate(t));
        return;
      }
    }

    // Calculate delta time
    const deltaTime = this.lastFrameTime ? (timestamp - this.lastFrameTime) : 16.67;
    this.lastFrameTime = timestamp;
    const delta = deltaTime / (1000 / this.targetFps);

    // Update scene timer
    this.updateSceneTimer(delta);

    // Clear canvas to black (prevents ghost trails)
    this.ctx.fillStyle = '#000';
    this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);

    // Draw cached background
    this.ctx.globalAlpha = this.transitionAlpha;
    this.ctx.drawImage(this.backgroundCanvas, 0, 0);

    // Update weather
    this.updateWeather(delta);

    // Update dynamic sprites
    for (const sprite of this.dynamicSprites) {
      this.updateSprite(sprite, delta);
    }

    // Collect all sprites and sort by zIndex
    const allSprites = [
      ...this.staticSprites,
      ...this.dynamicSprites,
      ...this.weatherEffects
    ].sort((a, b) => (a.zIndex || 0) - (b.zIndex || 0));

    // Draw all sprites
    for (const sprite of allSprites) {
      this.drawSprite(sprite);
    }

    this.ctx.globalAlpha = 1;

    this.animationId = requestAnimationFrame((t) => this.animate(t));
  },

  destroy() {
    if (this.animationId) {
      cancelAnimationFrame(this.animationId);
      this.animationId = null;
    }
    if (!this.fixedWidth) {
      window.removeEventListener('resize', this.handleResize);
    }
    this.staticSprites = [];
    this.dynamicSprites = [];
    this.weatherEffects = [];
    this.backgroundCanvas = null;
    this.backgroundCtx = null;
  }
};

// Self-registration with the screensaver registry
if (typeof window !== 'undefined') {
  window.EmojiCityScreensaver = EmojiCityScreensaver;

  if (window.ScreensaverRegistry) {
    ScreensaverRegistry.register('emoji-city', {
      name: 'Emoji City',
      module: EmojiCityScreensaver,
      canvas: true,
      options: {
        sceneDuration: {
          type: 'select',
          label: 'Scene Duration',
          default: 60,
          values: [30, 60, 90, 120],
          labels: ['30 seconds', '1 minute', '90 seconds', '2 minutes']
        },
        speed: {
          type: 'range',
          label: 'Animation Speed',
          default: 2,
          min: 1,
          max: 5
        },
        emojiDensity: {
          type: 'select',
          label: 'Emoji Density',
          default: 'normal',
          values: ['sparse', 'normal', 'busy'],
          labels: ['Sparse', 'Normal', 'Busy']
        },
        weatherEnabled: {
          type: 'checkbox',
          label: 'Weather Effects',
          default: true
        },
        sceneOrder: {
          type: 'select',
          label: 'Scene Order',
          default: 'sequential',
          values: ['sequential', 'random'],
          labels: ['Sequential', 'Random']
        },
        backgroundStyle: {
          type: 'select',
          label: 'Background Style',
          default: 'solid',
          values: ['solid', 'ascii'],
          labels: ['Solid Colors', 'ASCII Characters']
        }
      }
    });
  }
}
